{% extends "modern/base_modern.html" %}
{% block title %}Alertes - UpdateEngine{% endblock %}
{% block nav_alerts %}active{% endblock %}

{% block breadcrumb %}
<nav class="flex mb-4" aria-label="Breadcrumb">
  <ol class="flex items-center space-x-2 text-sm text-gray-500">
    <li><i class="fas fa-home"></i></li>
    <li><span class="mx-2">/</span></li>
    <li class="text-gray-900 font-medium">Alertes & Rapports</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="space-y-6">

  <!-- Page Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Alertes & Rapports</h1>
      <p class="text-sm text-gray-500 mt-1">Surveillance des echecs critiques en temps reel</p>
    </div>
    {% if total_critical > 0 %}
    <div class="flex items-center gap-2 px-4 py-2 bg-red-50 border border-red-200 rounded-xl">
      <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
      <span class="text-sm font-semibold text-red-700">{{ total_critical }} alerte{{ total_critical|pluralize }} critique{{ total_critical|pluralize }}</span>
    </div>
    {% endif %}
  </div>

  <!-- KPI Cards -->
  <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">

    <!-- Erreurs 24h -->
    <div class="bg-white rounded-xl border-l-4 {% if total_errors_24h > 0 %}border-red-500{% else %}border-green-400{% endif %} shadow-sm p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wider">Erreurs 24h</p>
          <p class="text-3xl font-bold {% if total_errors_24h > 0 %}text-red-600{% else %}text-green-600{% endif %} mt-1">
            {{ total_errors_24h }}
          </p>
        </div>
        <div class="w-12 h-12 {% if total_errors_24h > 0 %}bg-red-100 text-red-500{% else %}bg-green-100 text-green-500{% endif %} rounded-xl flex items-center justify-center text-xl">
          <i class="fas fa-times-circle"></i>
        </div>
      </div>
    </div>

    <!-- Erreurs 7j -->
    <div class="bg-white rounded-xl border-l-4 border-orange-400 shadow-sm p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wider">Erreurs 7j</p>
          <p class="text-3xl font-bold text-orange-600 mt-1">{{ total_errors_7d }}</p>
        </div>
        <div class="w-12 h-12 bg-orange-100 text-orange-500 rounded-xl flex items-center justify-center text-xl">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
      </div>
    </div>

    <!-- Machines injoignables -->
    <div class="bg-white rounded-xl border-l-4 {% if total_stale > 0 %}border-yellow-400{% else %}border-green-400{% endif %} shadow-sm p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wider">Machines perdues</p>
          <p class="text-3xl font-bold {% if total_stale > 0 %}text-yellow-600{% else %}text-green-600{% endif %} mt-1">
            {{ total_stale }}
          </p>
        </div>
        <div class="w-12 h-12 {% if total_stale > 0 %}bg-yellow-100 text-yellow-500{% else %}bg-green-100 text-green-500{% endif %} rounded-xl flex items-center justify-center text-xl">
          <i class="fas fa-wifi"></i>
        </div>
      </div>
    </div>

    <!-- Deploiements bloques -->
    <div class="bg-white rounded-xl border-l-4 {% if total_stuck > 0 %}border-blue-400{% else %}border-green-400{% endif %} shadow-sm p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase tracking-wider">Deploy. bloques</p>
          <p class="text-3xl font-bold {% if total_stuck > 0 %}text-blue-600{% else %}text-green-600{% endif %} mt-1">
            {{ total_stuck }}
          </p>
        </div>
        <div class="w-12 h-12 {% if total_stuck > 0 %}bg-blue-100 text-blue-500{% else %}bg-green-100 text-green-500{% endif %} rounded-xl flex items-center justify-center text-xl">
          <i class="fas fa-pause-circle"></i>
        </div>
      </div>
    </div>

  </div>

  <!-- Filter bar -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-3 flex items-center gap-3 flex-wrap">
    <span class="text-sm font-medium text-gray-500">Filtrer par severite :</span>
    <a href="{% url 'modern:alerts' %}" class="px-3 py-1 rounded-full text-xs font-medium transition-colors {% if not severity_filter %}bg-gray-800 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">
      Toutes
    </a>
    <a href="{% url 'modern:alerts' %}?severity=critical" class="px-3 py-1 rounded-full text-xs font-medium transition-colors {% if severity_filter == 'critical' %}bg-red-600 text-white{% else %}bg-red-100 text-red-700 hover:bg-red-200{% endif %}">
      <i class="fas fa-circle mr-1"></i> Critique
    </a>
    <a href="{% url 'modern:alerts' %}?severity=warning" class="px-3 py-1 rounded-full text-xs font-medium transition-colors {% if severity_filter == 'warning' %}bg-yellow-500 text-white{% else %}bg-yellow-100 text-yellow-700 hover:bg-yellow-200{% endif %}">
      <i class="fas fa-circle mr-1"></i> Avertissement
    </a>
    <div class="ml-auto flex items-center gap-2 text-xs text-gray-400">
      <i class="fas fa-sync-alt"></i>
      <span>Actualisation auto toutes les 60s</span>
    </div>
  </div>

  <!-- Alerts Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
      <h2 class="text-base font-semibold text-gray-900">
        <i class="fas fa-bell mr-2 text-red-500"></i>
        Alertes actives
      </h2>
      <span class="text-sm text-gray-500">{{ alerts|length }} alerte{{ alerts|length|pluralize }}</span>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severite</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Machine</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paquet</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
          </tr>
        </thead>
        <tbody id="alerts-table-body" class="bg-white divide-y divide-gray-200"
               hx-get="{% url 'modern:alerts_rows' %}"
               hx-trigger="every 60s"
               hx-swap="innerHTML">
          {% include "modern/partials/alerts_rows.html" %}
        </tbody>
      </table>
    </div>
    {% if not alerts %}
    <div class="text-center py-16">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check-circle text-2xl text-green-500"></i>
      </div>
      <p class="text-gray-700 font-semibold">Aucune alerte critique</p>
      <p class="text-gray-400 text-sm mt-1">Le parc fonctionne normalement</p>
    </div>
    {% endif %}
  </div>

  <!-- Stale Machines Section -->
  {% if stale_machines %}
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="px-6 py-4 border-b border-yellow-200 bg-yellow-50 flex items-center justify-between">
      <h2 class="text-base font-semibold text-yellow-800">
        <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>
        Machines sans contact depuis plus de 7 jours ({{ total_stale }})
      </h2>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Machine</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entite</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derniere vue</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for m in stale_machines %}
          <tr class="hover:bg-yellow-50 transition-colors">
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-gray-400 rounded-full flex-shrink-0"></span>
                <span class="text-sm font-medium text-gray-900">{{ m.name }}</span>
              </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">{{ m.entity.name|default:"-" }}</td>
            <td class="px-4 py-3">
              {% if m.lastsave %}
              <span class="text-sm text-red-600 font-medium">{{ m.lastsave|date:"d/m/Y H:i" }}</span>
              {% else %}
              <span class="text-sm text-gray-400 italic">Jamais</span>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-right">
              <a href="{% url 'modern:machine_detail' m.id %}" class="text-xs px-3 py-1 bg-primary-100 text-primary-700 rounded-lg hover:bg-primary-200 transition-colors">
                <i class="fas fa-eye mr-1"></i> Voir
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
  // Toast notification on page load if critical alerts
  document.addEventListener('DOMContentLoaded', function() {
    {% if total_critical > 0 %}
    showToast('{{ total_critical }} alerte{{ total_critical|pluralize }} critique{{ total_critical|pluralize }} detectee{{ total_critical|pluralize }}', 'critical');
    {% endif %}
  });
</script>
{% endblock %}
